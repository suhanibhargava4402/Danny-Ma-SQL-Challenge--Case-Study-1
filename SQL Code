select s.customer_id, sum(m.price) from dannys_diner.sales s join dannys_diner.menu m on s.product_id=m.product_id group by s.customer_id order by s.customer_id;
select customer_id, count(distinct order_date) from dannys_diner.sales group by customer_id order by customer_id;
with first_item as (select customer_id, product_id,row_number() over(partition by customer_id order by order_date) as ranking from dannys_diner.sales) select customer_id,product_id from first_item where ranking=1;
select product_id, count(product_id) as total_purchases from dannys_diner.sales group by product_id order by total_purchases desc limit 1;
with popular_purchase as(select customer_id, product_id, count(product_id) as total_purchases, row_number() over(partition by customer_id order by count(product_id) desc) as ranking from dannys_diner.sales group by customer_id, product_id) select customer_id, product_id, total_purchases from popular_purchase where ranking=1;
with rank_first as(select me.customer_id, s.product_id, row_number() over (partition by s.customer_id order by s.order_date) as r from dannys_diner.members me join dannys_diner.sales s on me.customer_id=s.customer_id where s.order_date>=me.join_date) select customer_id, product_id from rank_first where r=1;
with rank_first_before as(select me.customer_id, s.product_id, rank() over (partition by s.customer_id order by s.order_date desc) as r from dannys_diner.members me join dannys_diner.sales s on me.customer_id=s.customer_id where s.order_date<me.join_date) select customer_id, product_id from rank_first_before where r=1;
select me.customer_id, count(s.product_id) as total_items,sum(m.price) as total_amount_spent from dannys_diner.members me join dannys_diner.sales s on me.customer_id=s.customer_id join dannys_diner.menu m on s.product_id=m.product_id where s.order_date<me.join_date group by me.customer_id order by me.customer_id;
select s.customer_id, sum(case when m.product_name='sushi' then m.price*10*2 else m.price*10 end) as points from dannys_diner.sales s join dannys_diner.menu m on s.product_id=m.product_id group by s.customer_id order by s.customer_id;
select s.customer_id, sum(case when s.order_date>=me.join_date or m.product_name='sushi' then m.price*10*2 else m.price*10 end)as points from dannys_diner.sales s join dannys_diner.members me on s.customer_id=me.customer_id join dannys_diner.menu m on s.product_id=m.product_id where s.order_date<='2021-01-31' group by s.customer_id order by s.customer_id;
